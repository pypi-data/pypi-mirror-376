---
- name: Check if role has been completed
  stat:
    path: /opt/marker_file_mysqld
  register: role_complete

- name: Skip role if already completed
  debug:
    msg: "Role already completed. Skipping..."
  when: role_complete.stat.exists
  tags: always

- block:
    - name: Execute the role tasks
      debug:
        msg: "Executing role tasks..."

    ##################################### INSTALL MYSQLD ##################################
    - name: Install mariadb-server  (state=present is optional)
      apt:
        name: mariadb-server
        state: present

    ###################################### CONFIG MYSQLD ######################################
    - name: Update mysql root password for all root accounts
      mysql_user: name=root host={{ item }} password={{ mysql_root_password }} priv=*.*:ALL,GRANT
      with_items:
        - 127.0.0.1
        - ::1
        - localhost

    - name: copy .my.cnf file with root password credentials
      ansible.builtin.template:
        src: .my.cnf.j2
        dest: /root/.my.cnf
        owner: root
        mode: "0600"

    - name: delete anonymous MySQL server user for $hostname
      action: mysql_user user="" host="$hostname" state="absent"

    - name: delete anonymous MySQL server user for localhost
      action: mysql_user user="" state="absent"

    - name: remove the MySQL test database
      action: mysql_db db=test state=absent

    - name: Create a marker file after role completion
      ansible.builtin.file:
        path: /opt/marker_file_mysqld
        state: touch
        mode: u=rw,g=r,o=r
  when: not role_complete.stat.exists
