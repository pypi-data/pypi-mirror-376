<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{{QUIZ_TITLE}}</title>
    <style>
        :root {
            --bg-color: #f5f5f5;
            --container-bg: white;
            --text-color: #333;
            --border-color: #ddd;
            --option-bg: white;
            --option-border: #ccc;
            --option-hover: #e8f4f8;
            --option-selected: #d4edda;
            --option-selected-border: #28a745;
            --question-bg: #fafafa;
            --current-question-bg: #f8f9fa;
            --stats-bg: #e7f3ff;
            --progress-bg: #f0f0f0;
            --shadow: rgba(0,0,0,0.1);
        }
        
        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --container-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --border-color: #555;
            --option-bg: #3a3a3a;
            --option-border: #666;
            --option-hover: #404040;
            --option-selected: #2d5a2d;
            --option-selected-border: #4caf50;
            --question-bg: #333;
            --current-question-bg: #2a2a2a;
            --stats-bg: #1e3a5f;
            --progress-bg: #444;
            --shadow: rgba(0,0,0,0.3);
        }
        
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .container {
            background: var(--container-bg);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px var(--shadow);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            position: relative;
        }
        .top-right-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .theme-toggle {
            background: var(--option-bg);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            padding: 8px;
            cursor: pointer;
            font-size: 16px;
            color: var(--text-color);
            transition: all 0.3s ease;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .theme-toggle:hover {
            background: var(--option-hover);
        }
        .question {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background: var(--question-bg);
            transition: all 0.3s ease;
        }
        .options {
            margin: 10px 0;
        }
        .option {
            margin: 5px 0;
            padding: 10px;
            background: var(--option-bg);
            border: 1px solid var(--option-border);
            border-radius: 3px;
            cursor: pointer;
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        .option:hover {
            background: var(--option-hover);
        }
        .option.selected {
            background: var(--option-selected);
            border-color: var(--option-selected-border);
        }

        .option.feedback-correct {
            background: #ffffff !important;
            border-color: #2d731c !important;
            border-width: 3px !important;
            color: #155724 !important;
            position: relative;
        }
        
        .option.feedback-correct::after {
            content: '‚úì –ü—Ä–∞–≤–∏–ª—å–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å';
            position: absolute;
            top: -25px;
            right: 0;
            background: #2d731c;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
            z-index: 10;
        }

        .option.feedback-incorrect {
            background: #f8d7da !important;
            border-color: #dc3545 !important;
            border-width: 3px !important;
            color: #721c24 !important;
            position: relative;
        }
        
        .option.feedback-incorrect::after {
            content: '‚úó –í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å';
            position: absolute;
            top: -25px;
            right: 0;
            background: #dc3545;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
            z-index: 10;
        }

        .option.disabled {
            cursor: not-allowed !important;
            opacity: 0.6 !important;
            pointer-events: none !important;
        }

        [data-theme="dark"] .option.feedback-correct {
            background: #2d5a2d !important;
            border-color: #4caf50 !important;
            color: #a5d6a7 !important;
        }

        [data-theme="dark"] .option.feedback-correct.disabled {
            background: #2d5a2d !important;
            border-color: #4caf50 !important;
            color: #a5d6a7 !important;
            opacity: 1 !important;
        }

        [data-theme="dark"] .option.feedback-incorrect {
            background: #c20909 !important;
            border-color: #f44336 !important;
            color: #ef9a9a !important;
        }
        .question-image {
            max-width: 100%;
            height: auto;
            margin: 15px 0;
            border-radius: 5px;
            box-shadow: 0 2px 8px var(--shadow);
            display: block;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .question-image:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px var(--shadow);
        }
        .option-image {
            max-width: 300px;
            height: auto;
            margin: 5px 0;
            border-radius: 3px;
            box-shadow: 0 1px 4px var(--shadow);
            display: block;
        }
        .option-content {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .button-container {
            position: relative;
            margin: 20px 0;
            height: 50px;
        }
        #submit-answer-btn {
            position: absolute;
            left: 0;
        }
        #continue-btn {
            position: absolute;
            right: 0;
        }
        .hidden {
            display: none;
        }
        .stats {
            background: var(--stats-bg);
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            transition: background-color 0.3s ease;
        }
        .correct {
            color: #28a745;
        }
        .incorrect {
            color: #dc3545;
        }
        .progress {
            width: 100%;
            background: var(--progress-bg);
            border-radius: 10px;
            margin: 20px 0;
            position: relative;
            height: 30px;
            transition: background-color 0.3s ease;
        }
        #progress-fill {
            height: 100%;
            background: #007bff;
            border-radius: 10px;
            width: 0%;
            transition: width 0.3s ease;
        }
        #progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-color);
            font-weight: bold;
        }
        .current-question {
            background: var(--current-question-bg);
            padding: 30px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #007bff;
            transition: background-color 0.3s ease;
        }
        #loading {
            text-align: center;
            padding: 40px;
        }
        #loading p {
            color: var(--text-color);
            font-style: italic;
        }
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        .results-table th {
            background-color: var(--question-bg);
            border: 1px solid var(--border-color);
            padding: 12px;
            text-align: left;
            font-weight: bold;
            color: var(--text-color);
        }
        .results-table td {
            border: 1px solid var(--border-color);
            padding: 12px;
            vertical-align: top;
            color: var(--text-color);
        }
        .results-table tr:nth-child(even) {
            background-color: var(--question-bg);
        }
        .results-table tr:hover {
            background-color: var(--option-hover);
        }
        
        /* Mobile responsive table */
        @media screen and (max-width: 768px) {
            .results-table {
                font-size: 12px;
                overflow-x: auto;
                display: block;
                white-space: nowrap;
            }
            
            /* Mobile responsive input */
            #username {
                width: 100% !important;
                max-width: 100% !important;
                box-sizing: border-box !important;
            }
            
            /* Mobile spacing between top controls and H1 */
            h1 {
                margin-top: 60px !important;
            }
            .results-table thead, 
            .results-table tbody, 
            .results-table th, 
            .results-table td, 
            .results-table tr {
                display: block;
            }
            .results-table thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            .results-table tr {
                border: 1px solid var(--border-color);
                margin-bottom: 10px;
                padding: 10px;
                border-radius: 5px;
                white-space: normal;
            }
            .results-table td {
                border: none;
                padding: 5px 0;
                position: relative;
                padding-left: 50%;
            }
            .results-table td:before {
                content: attr(data-label) ": ";
                position: absolute;
                left: 6px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                font-weight: bold;
            }
        }
        .answer-correct {
            color: #28a745;
            font-weight: bold;
        }
        .answer-incorrect {
            color: #dc3545;
            font-weight: bold;
        }
        .correct-answer-hint {
            color: var(--text-color);
            font-size: 12px;
            margin-top: 4px;
        }
        .user-info {
            background: var(--option-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 14px;
            color: var(--text-color);
            transition: all 0.3s ease;
            display: none;
        }
        .user-info.visible {
            display: block;
        }
        .user-info:hover {
            background: var(--option-hover);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-right-controls">
            <div class="user-info" id="user-info">
                üë§ <span id="username-display"></span>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()" title="–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ —Ç–µ–º—É">üåô</button>
        </div>
        <h1>{{QUIZ_TITLE}}</h1>
        
        <!-- Loading State -->
        <div id="loading" class="section">
            <h2>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</h2>
            <p>–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–∞—à–∏—Ö –¥–∞–Ω–∏—Ö...</p>
        </div>
        
        <!-- Registration Form -->
        <div id="registration" class="section hidden">
            <h2>–ó–∞—Ä–µ—î—Å—Ç—Ä—É–π—Ç–µ—Å—è –¥–ª—è –ø–æ—á–∞—Ç–∫—É —Ç–µ—Å—Ç—É</h2>
            <input type="text" id="username" placeholder="–í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ —ñ–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞" style="padding: 10px; width: 100%; max-width: 300px; box-sizing: border-box;">
            <button onclick="registerUser()">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
        </div>
        
        <!-- Test Section -->
        <div id="test-section" class="section hidden">
            <div id="progress-bar" class="progress">
                <div id="progress-fill"></div>
                <span id="progress-text">–ü–∏—Ç–∞–Ω–Ω—è 1 –∑ 5</span>
            </div>
            <div id="current-question-container"></div>
            <div class="button-container">
                <button id="submit-answer-btn" onclick="submitCurrentAnswer()" disabled>–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å</button>
                <button id="continue-btn" onclick="continueToNextQuestion()" class="hidden">–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏</button>
            </div>
        </div>
        
        <!-- Results Section -->
        <div id="results" class="section hidden">
            <div id="results-content"></div>
        </div>
    </div>

    <script>
        let currentUsername = null;
        let currentUserId = null;
        let questions = {{QUESTIONS_DATA}};
        let currentQuestionIndex = 0;
        let selectedAnswer = null;
        let testResults = [];
        
        // Theme management
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è';
            }
        }
        
        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme');
            const toggleButton = document.querySelector('.theme-toggle');
            
            if (currentTheme === 'dark') {
                document.body.removeAttribute('data-theme');
                toggleButton.textContent = 'üåô';
                localStorage.setItem('theme', 'light');
            } else {
                document.body.setAttribute('data-theme', 'dark');
                toggleButton.textContent = '‚òÄÔ∏è';
                localStorage.setItem('theme', 'dark');
            }
        }
        
        // Username display management
        function showUsername(username) {
            document.getElementById('username-display').textContent = username;
            document.getElementById('user-info').classList.add('visible');
        }
        
        function hideUsername() {
            document.getElementById('user-info').classList.remove('visible');
        }
        
        // Cookie management
        function setCookie(name, value, days = 30) {
            const expires = new Date();
            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
        }
        
        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }
        
        // Initialize theme and check for stored user ID on page load
        initializeTheme();
        checkStoredUserId();
        
        async function checkStoredUserId() {
            const storedUserId = getCookie('user_id');
            
            if (storedUserId) {
                // User ID stored, verify it with server
                try {
                    const response = await fetch(`/api/verify-user/${storedUserId}`);
                    const data = await response.json();
                    
                    if (response.ok && data.valid) {
                        // Valid user ID, set user data
                        currentUserId = data.user_id;
                        currentUsername = data.username;
                        currentQuestionIndex = data.next_question_index;
                        
                        // Show username on page
                        showUsername(currentUsername);
                        
                        if (data.test_completed && data.final_results) {
                            // Test is completed, show final results
                            showCompletedTestResults(data.final_results);
                        } else {
                            // Test not completed, resume test
                            await hideLoadingShowTest();
                        }
                    } else {
                        // Invalid user ID, need registration
                        hideLoadingShowRegistration();
                    }
                } catch (error) {
                    // Error verifying, need registration
                    hideLoadingShowRegistration();
                }
            } else {
                // No stored user ID, show registration form
                hideLoadingShowRegistration();
            }
        }
        
        function hideLoadingShowRegistration() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('registration').classList.remove('hidden');
        }
        
        async function hideLoadingShowTest() {
            document.getElementById('loading').classList.add('hidden');
            await startTest();
        }
        
        
        
        async function registerUser() {
            const username = document.getElementById('username').value.trim();
            if (!username) {
                alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å —ñ–º\'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞');
                return;
            }
            
            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username: username })
                });
                
                const data = await response.json();
                if (response.ok) {
                    currentUsername = data.username;
                    currentUserId = data.user_id;
                    setCookie('user_id', currentUserId);
                    currentQuestionIndex = 0; // New user starts from beginning
                    
                    // Show username on page
                    showUsername(currentUsername);
                    
                    document.getElementById('registration').classList.add('hidden');
                    await startTest();
                } else {
                    alert(data.error || '–ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó');
                }
            } catch (error) {
                alert('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
            }
        }
        
        
        async function startTest() {
            selectedAnswer = null;
            testResults = [];
            document.getElementById('test-section').classList.remove('hidden');
            await showCurrentQuestion();
        }
        
        async function showCurrentQuestion() {
            if (currentQuestionIndex >= questions.length) {
                // Test completed - fetch final results from server to ensure consistency
                await fetchAndShowFinalResults();
                return;
            }
            
            const question = questions[currentQuestionIndex];
            selectedAnswer = null;
            
            // Update progress
            const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
            document.getElementById('progress-fill').style.width = progress + '%';
            document.getElementById('progress-text').textContent = `–ü–∏—Ç–∞–Ω–Ω—è ${currentQuestionIndex + 1} –∑ ${questions.length}`;
            
            // Show current question
            const container = document.getElementById('current-question-container');
            container.innerHTML = `
                <div class="current-question">
                    ${question.question ? `<h3>${question.question}</h3>` : ''}
                    ${question.image ? `<a href="${question.image}" target="_blank"><img src="${question.image}" alt="Question image" class="question-image"></a>` : ''}
                    <div class="options">
                        ${question.options.map((option, optionIndex) => {
                            const isImageOption = option.startsWith('/');
                            if (isImageOption) {
                                return `
                                    <div class="option" onclick="selectCurrentAnswer(${optionIndex})" id="option_${optionIndex}">
                                        <div class="option-content">
                                            <img src="${option}" alt="Option ${optionIndex + 1}" class="option-image">
                                        </div>
                                    </div>
                                `;
                            } else {
                                return `
                                    <div class="option" onclick="selectCurrentAnswer(${optionIndex})" id="option_${optionIndex}">
                                        ${option}
                                    </div>
                                `;
                            }
                        }).join('')}
                    </div>
                </div>
            `;
            
            // Reset button states
            const submitBtn = document.getElementById('submit-answer-btn');
            const continueBtn = document.getElementById('continue-btn');
            
            submitBtn.classList.remove('hidden');
            submitBtn.disabled = true;
            continueBtn.classList.add('hidden');
        }
        
        function selectCurrentAnswer(optionIndex) {
            // Don't allow selection if already submitted
            if (document.querySelector('.option.disabled')) {
                return;
            }
            
            selectedAnswer = optionIndex;
            
            // Clear previous selections
            document.querySelectorAll('.option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Select current option
            document.getElementById(`option_${optionIndex}`).classList.add('selected');
            
            // Enable submit button
            document.getElementById('submit-answer-btn').disabled = false;
        }
        
        async function submitCurrentAnswer() {
            if (selectedAnswer === null) {
                alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥—å');
                return;
            }
            
            const question = questions[currentQuestionIndex];
            
            try {
                const response = await fetch('/api/submit-answer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: currentUserId,
                        question_id: question.id,
                        selected_answer: selectedAnswer
                    })
                });
                
                const data = await response.json();
                testResults.push({
                    questionId: question.id,
                    question: question.question,
                    image: question.image,
                    selectedAnswer: question.options[selectedAnswer],
                    isCorrect: data.is_correct,
                    timeTaken: data.time_taken || 0
                });
                
                // Show feedback on selected answer
                showAnswerFeedback(data.is_correct, data.correct_answer);
                
            } catch (error) {
                alert('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ: ' + error.message);
            }
        }

        function showAnswerFeedback(isCorrect, correctAnswer) {
            // Apply feedback styling to selected answer
            const selectedOption = document.querySelector('.option.selected');
            if (selectedOption) {
                selectedOption.classList.add(isCorrect ? 'feedback-correct' : 'feedback-incorrect');
            }
            
            // If answer is incorrect, also highlight the correct answer
            if (!isCorrect) {
                const correctOption = document.getElementById(`option_${correctAnswer}`);
                if (correctOption) {
                    correctOption.classList.add('feedback-correct');
                }
            }
            
            // Disable all options to prevent further selection
            document.querySelectorAll('.option').forEach(option => {
                option.classList.add('disabled');
            });
            
            // Hide submit button and show continue button
            const submitBtn = document.getElementById('submit-answer-btn');
            const continueBtn = document.getElementById('continue-btn');
            
            submitBtn.classList.add('hidden');
            continueBtn.classList.remove('hidden');
        }

        async function continueToNextQuestion() {
            // Move to next question
            currentQuestionIndex++;
            await showCurrentQuestion();
        }
        
        async function fetchAndShowFinalResults() {
            try {
                // Fetch final results from server to ensure consistency with page reload
                const response = await fetch(`/api/verify-user/${currentUserId}`);
                const data = await response.json();
                
                if (response.ok && data.valid && data.test_completed && data.final_results) {
                    // Use the same function as page reload to ensure identical display
                    showCompletedTestResults(data.final_results);
                } else {
                    // Fallback to client-side results if server fetch fails
                    showFinalResults();
                }
            } catch (error) {
                console.error('Error fetching final results from server:', error);
                // Fallback to client-side results
                showFinalResults();
            }
        }
        
        function formatQuestionForDisplay(questionText, questionImage) {
            if (questionImage && questionImage.startsWith('/')) {
                // Display image with optional text
                let html = `<img src="${questionImage}" alt="Question image" style="max-width: 200px; max-height: 150px; border-radius: 5px;">`;
                if (questionText) {
                    html = `${questionText}<br>${html}`;
                }
                return html;
            } else if (questionText) {
                // Text only
                return questionText;
            } else {
                // Fallback
                return questionImage || 'No question content';
            }
        }

        function formatAnswerForDisplay(answerText) {
            if (answerText && answerText.startsWith('/')) {
                // Display image for answer option
                return `<img src="${answerText}" alt="Answer option" style="max-width: 100px; max-height: 75px; border-radius: 3px;">`;
            } else {
                // Text answer
                return answerText || '';
            }
        }

        function showFinalResults() {
            document.getElementById('test-section').classList.add('hidden');
            
            const container = document.getElementById('results-content');
            container.innerHTML = '';
            
            const correctCount = testResults.filter(r => r.isCorrect).length;
            const totalCount = testResults.length;
            const percentage = Math.round((correctCount / totalCount) * 100);
            const totalTime = testResults.reduce((sum, r) => sum + r.timeTaken, 0);
            const avgTime = totalTime / totalCount;
            
            // Build table with results using CSS classes
            let tableContent = `
                <p><strong>–†–µ–∑—É–ª—å—Ç–∞—Ç:</strong> ${correctCount}/${totalCount} (${percentage}%)</p>
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>–ü–∏—Ç–∞–Ω–Ω—è</th>
                            <th>–í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å</th>
                            <th style="text-align: center;">–ü—Ä–∞–≤–∏–ª—å–Ω–æ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            testResults.forEach((result, index) => {
                // Note: testResults uses different property names than server data
                const correctAnswer = questions[index] ? questions[index].options[questions[index].correct_answer] : 'N/A';
                tableContent += `
                    <tr>
                        <td data-label="–ü–∏—Ç–∞–Ω–Ω—è">${formatQuestionForDisplay(result.question, result.image)}</td>
                        <td data-label="–í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å">
                            <span class="${result.isCorrect ? 'answer-correct' : 'answer-incorrect'}">
                                ${formatAnswerForDisplay(result.selectedAnswer)}
                            </span>
                            ${!result.isCorrect ? `<div class="correct-answer-hint">–ü—Ä–∞–≤–∏–ª—å–Ω–∞: ${formatAnswerForDisplay(correctAnswer)}</div>` : ''}
                        </td>
                        <td data-label="–ü—Ä–∞–≤–∏–ª—å–Ω–æ" style="text-align: center;">
                            <span class="${result.isCorrect ? 'correct' : 'incorrect'}" style="font-size: 18px;">
                                ${result.isCorrect ? '‚úì' : '‚úó'}
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            tableContent += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableContent;
            
            document.getElementById('test-section').classList.add('hidden');
            document.getElementById('results').classList.remove('hidden');
        }
        
        function showCompletedTestResults(finalResults) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('test-section').classList.add('hidden');
            
            const container = document.getElementById('results-content');
            container.innerHTML = '';
            
            const correctCount = finalResults.correct_count;
            const totalCount = finalResults.total_count;
            const percentage = finalResults.percentage;
            
            container.innerHTML = `
                <p><strong>–†–µ–∑—É–ª—å—Ç–∞—Ç:</strong> ${correctCount}/${totalCount} (${percentage}%)</p>
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>–ü–∏—Ç–∞–Ω–Ω—è</th>
                            <th>–í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å</th>
                            <th style="text-align: center;">–ü—Ä–∞–≤–∏–ª—å–Ω–æ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${finalResults.test_results.map((result, index) => `
                            <tr>
                                <td data-label="–ü–∏—Ç–∞–Ω–Ω—è">${formatQuestionForDisplay(result.question, result.image)}</td>
                                <td data-label="–í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å">
                                    <span class="${result.is_correct ? 'answer-correct' : 'answer-incorrect'}">
                                        ${formatAnswerForDisplay(result.selected_answer)}
                                    </span>
                                    ${!result.is_correct ? `<div class="correct-answer-hint">–ü—Ä–∞–≤–∏–ª—å–Ω–∞: ${formatAnswerForDisplay(result.correct_answer)}</div>` : ''}
                                </td>
                                <td data-label="–ü—Ä–∞–≤–∏–ª—å–Ω–æ" style="text-align: center;">
                                    <span class="${result.is_correct ? 'correct' : 'incorrect'}" style="font-size: 18px;">
                                        ${result.is_correct ? '‚úì' : '‚úó'}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('results').classList.remove('hidden');
        }
    </script>
    
    <div style="text-align: center; margin-top: 40px; padding: 20px; border-top: 1px solid var(--border-color); color: var(--text-color); font-size: 12px; opacity: 0.7;">
        WebQuiz v{{WEBQUIZ_VERSION}}
    </div>
</body>
</html>