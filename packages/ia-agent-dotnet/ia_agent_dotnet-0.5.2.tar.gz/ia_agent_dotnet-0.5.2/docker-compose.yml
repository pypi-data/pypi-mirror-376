version: '3.8'

services:
  ia-agent:
    build: .
    container_name: ia-agent-main
    restart: unless-stopped
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - DEBUG_MODE=${DEBUG_MODE:-false}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - AI_PROVIDER=${AI_PROVIDER:-deepseek}
      - AI_MODEL=${AI_MODEL:-deepseek-coder}
      - AI_TEMPERATURE=${AI_TEMPERATURE:-0.1}
      - AI_MAX_TOKENS=${AI_MAX_TOKENS:-4000}
      - CHROMADB_PERSIST_DIRECTORY=/app/memory/vector
      - TEMP_DIRECTORY=/app/temp
      - OUTPUT_DIRECTORY=/app/output
      - MAX_CONCURRENT_AGENTS=${MAX_CONCURRENT_AGENTS:-3}
      - AGENT_TIMEOUT=${AGENT_TIMEOUT:-60}
    volumes:
      - ./logs:/app/logs
      - ./memory:/app/memory
      - ./temp:/app/temp
      - ./output:/app/output
      - ./projects:/app/projects:ro  # Proyectos .NET de solo lectura
    networks:
      - ia-agent-network
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.path.insert(0, 'src'); from agents.analysis_agent import analysis_agent; print('OK')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Servicio opcional para ChromaDB persistente (si se necesita)
  chromadb:
    image: chromadb/chroma:latest
    container_name: ia-agent-chromadb
    restart: unless-stopped
    ports:
      - "8001:8000"
    volumes:
      - chromadb_data:/chroma/chroma
    environment:
      - CHROMA_SERVER_HOST=0.0.0.0
      - CHROMA_SERVER_HTTP_PORT=8000
    networks:
      - ia-agent-network
    profiles:
      - chromadb  # Solo se ejecuta con --profile chromadb

  # Servicio de monitoreo (opcional)
  monitoring:
    build: .
    container_name: ia-agent-monitoring
    restart: unless-stopped
    command: ["python", "-c", "import sys; sys.path.insert(0, 'src'); from monitoring.performance_optimizer import performance_optimizer; import time; time.sleep(3600)"]
    environment:
      - LOG_LEVEL=INFO
      - DEBUG_MODE=false
    volumes:
      - ./logs:/app/logs
      - ./memory:/app/memory
    networks:
      - ia-agent-network
    depends_on:
      - ia-agent
    profiles:
      - monitoring  # Solo se ejecuta con --profile monitoring

volumes:
  chromadb_data:
    driver: local

networks:
  ia-agent-network:
    driver: bridge
