
<!doctype html><html lang="zh"><meta charset="utf-8"/>
<title>Leakage Buster æŠ¥å‘Š v1.0</title>
<style>
  body{font-family:system-ui,Segoe UI,Arial,PingFang SC; margin:24px; line-height:1.6}
  .container{max-width:1200px; margin:0 auto}
  .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; padding:2rem; border-radius:12px; margin-bottom:2rem}
  .header h1{margin:0; font-size:2.5rem; font-weight:300}
  .header p{margin:0.5rem 0 0 0; opacity:0.9; font-size:1.1rem}
  
  /* ç›®å½•æ ·å¼ */
  .toc{background:#f8f9fa; border:1px solid #e9ecef; border-radius:8px; padding:1.5rem; margin-bottom:2rem}
  .toc h2{margin-top:0; color:#495057; border-bottom:2px solid #dee2e6; padding-bottom:0.5rem}
  .toc ul{list-style:none; padding:0; margin:0}
  .toc li{margin:0.5rem 0}
  .toc a{color:#007bff; text-decoration:none; font-weight:500}
  .toc a:hover{text-decoration:underline}
  .toc .toc-level-1{margin-left:0}
  .toc .toc-level-2{margin-left:1rem; color:#6c757d}
  .toc .toc-level-3{margin-left:2rem; color:#6c757d; font-size:0.9rem}
  
  /* é£é™©çŸ©é˜µæ ·å¼ */
  .risk-matrix{background:#fff; border:1px solid #dee2e6; border-radius:8px; padding:1.5rem; margin-bottom:2rem; box-shadow:0 2px 4px rgba(0,0,0,0.1)}
  .risk-matrix h2{margin-top:0; color:#495057; border-bottom:2px solid #dee2e6; padding-bottom:0.5rem}
  .matrix-grid{display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:1rem; margin:1rem 0}
  .matrix-card{background:#f8f9fa; border-radius:6px; padding:1rem; text-align:center; border-left:4px solid}
  .matrix-card.high{border-left-color:#dc3545; background:#f8d7da}
  .matrix-card.medium{border-left-color:#ffc107; background:#fff3cd}
  .matrix-card.low{border-left-color:#28a745; background:#d4edda}
  .matrix-card .count{font-size:2rem; font-weight:bold; margin:0}
  .matrix-card .label{font-size:0.9rem; color:#6c757d; margin:0.5rem 0 0 0}
  
  /* é›·è¾¾å›¾æ ·å¼ */
  .radar-chart{background:#fff; border:1px solid #dee2e6; border-radius:8px; padding:1.5rem; margin:1.5rem 0; box-shadow:0 2px 4px rgba(0,0,0,0.1)}
  .radar-chart h3{margin-top:0; color:#495057; border-bottom:2px solid #dee2e6; padding-bottom:0.5rem}
  .radar-container{display:flex; justify-content:center; align-items:center; min-height:400px}
  .radar-svg{max-width:100%; height:auto}
  
  /* ç­–ç•¥å®¡è®¡æ ·å¼ */
  .policy-audit{background:#e3f2fd; border:2px solid #2196f3; border-radius:8px; padding:1.5rem; margin:1.5rem 0}
  .policy-audit h2{color:#1976d2; margin-top:0}
  .policy-summary{display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:1rem; margin:1rem 0}
  .policy-stat{background:white; border-radius:6px; padding:1rem; text-align:center; border:1px solid #bbdefb}
  .policy-stat .value{font-size:1.5rem; font-weight:bold; color:#1976d2}
  .policy-stat .label{font-size:0.9rem; color:#666}
  
  .risk{border:1px solid #ddd; border-radius:8px; padding:12px 16px; margin:12px 0; transition:all 0.3s ease}
  .risk:hover{box-shadow:0 4px 8px rgba(0,0,0,0.1); transform:translateY(-2px)}
  .sev-high{border-left:6px solid #d9534f; background:#fdf2f2}
  .sev-medium{border-left:6px solid #f0ad4e; background:#fff3cd}
  .sev-low{border-left:6px solid #5bc0de; background:#d1ecf1}
  
  code,pre{background:#f8f8f8; padding:2px 4px; border-radius:4px; font-family:Monaco,Consolas,monospace}
  .summary{background:#f9f9f9; border:1px solid #ddd; border-radius:8px; padding:16px; margin:16px 0}
  .fix-card{background:#e8f5e8; border:1px solid #c3e6c3; border-radius:8px; padding:12px; margin:8px 0}
  .fix-high{background:#fdf2f2; border-color:#f5c6cb}
  .fix-medium{background:#fff3cd; border-color:#ffeaa7}
  .fix-low{background:#d1ecf1; border-color:#bee5eb}
  
  .stat-leak-section{background:#f0f8ff; border:2px solid #4a90e2; border-radius:8px; padding:16px; margin:16px 0}
  .leak-score{font-weight:bold; color:#d9534f; background:#fff; padding:2px 6px; border-radius:4px; border:1px solid #d9534f}
  .evidence-toggle{cursor:pointer; color:#4a90e2; text-decoration:underline; font-weight:500}
  .evidence-toggle:hover{color:#2c5aa0}
  .evidence-details{display:none; margin-top:8px; padding:8px; background:#f8f9fa; border-radius:4px; border:1px solid #dee2e6}
  .simulation-results{background:#fff3cd; border:1px solid #ffeaa7; border-radius:8px; padding:12px; margin:12px 0}
  .comparison-table{border-collapse:collapse; width:100%; margin:8px 0; background:white}
  .comparison-table th, .comparison-table td{border:1px solid #ddd; padding:8px; text-align:left}
  .comparison-table th{background:#f5f5f5; font-weight:600}
  .comparison-table tr:nth-child(even){background:#f9f9f9}
  .leak-high{background:#fdf2f2}
  .leak-medium{background:#fff3cd}
  .leak-low{background:#d1ecf1}
  
  ul{margin:8px 0; padding-left:20px}
  .section{margin:2rem 0}
  .section h2{color:#495057; border-bottom:2px solid #dee2e6; padding-bottom:0.5rem; margin-bottom:1rem}
  
  /* é¡µè„šæ ·å¼ */
  .footer{background:#f8f9fa; border-top:1px solid #dee2e6; padding:2rem; margin-top:3rem; text-align:center; color:#6c757d}
  .footer .meta{display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:1rem; margin:1rem 0}
  .footer .meta-item{background:white; padding:1rem; border-radius:6px; border:1px solid #dee2e6}
  .footer .meta-item .label{font-size:0.9rem; color:#6c757d; margin-bottom:0.5rem}
  .footer .meta-item .value{font-family:Monaco,Consolas,monospace; font-size:0.8rem; color:#495057}
  
  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 768px) {
    .container{margin:0; padding:0 1rem}
    .header{padding:1.5rem; margin-bottom:1rem}
    .header h1{font-size:2rem}
    .matrix-grid{grid-template-columns:1fr}
    .policy-summary{grid-template-columns:1fr}
    .radar-container{min-height:300px}
  }
  
  /* æ‰“å°æ ·å¼ */
  @media print {
    .header{background:#667eea !important; -webkit-print-color-adjust:exact}
    .risk:hover{box-shadow:none; transform:none}
    .evidence-details{display:block !important}
  }
</style>

<div class="container">
  <!-- å¤´éƒ¨ -->
  <div class="header">
    <h1>ğŸ•µï¸â€â™‚ï¸ Leakage Buster æŠ¥å‘Š v1.0</h1>
    <p>æ•°æ®æ³„æ¼æ£€æµ‹ä¸å£å¾„ä¸€è‡´æ€§å®¡è®¡æŠ¥å‘Š</p>
    <div style="margin-top:1rem; font-size:0.9rem; opacity:0.8">
      <div>ç›®æ ‡åˆ—ï¼š<code>{{ meta["target"] }}</code> | æ—¶é—´åˆ—ï¼š<code>{{ meta["time_col"] or "æœªæŒ‡å®š" }}</code> | CVç­–ç•¥ï¼š<code>{{ meta["cv_type"] or "æœªæŒ‡å®š" }}</code></div>
      <div>æ ·æœ¬æ•°ï¼š{{ meta["n_rows"] }} | ç‰¹å¾æ•°ï¼š<code>{{ meta["n_cols"] }}</code> | ç”Ÿæˆæ—¶é—´ï¼š{{ now }}</div>
      {% if meta.get("simulate_cv") %}
      <div>æ—¶åºæ¨¡æ‹Ÿï¼š<code>{{ meta["simulate_cv"] }}</code> | æ³„æ¼é˜ˆå€¼ï¼š<code>{{ meta["leak_threshold"] }}</code></div>
      {% endif %}
      {% if meta.get("cv_policy_file") %}
      <div>ç­–ç•¥æ–‡ä»¶ï¼š<code>{{ meta["cv_policy_file"] }}</code></div>
      {% endif %}
      {% if meta.get("engine") %}
      <div>å¼•æ“ï¼š<code>{{ meta["engine"] }}</code> | å¹¶è¡Œæ•°ï¼š<code>{{ meta.get("n_jobs", "auto") }}</code> | å†…å­˜é™åˆ¶ï¼š<code>{{ meta.get("memory_cap", "auto") }}MB</code></div>
      {% endif %}
    </div>
  </div>

  <!-- ç›®å½• -->
  <div class="toc">
    <h2>ï¿½ï¿½ æŠ¥å‘Šç›®å½•</h2>
    <ul>
      <li class="toc-level-1"><a href="#risk-matrix">é£é™©çŸ©é˜µæ¦‚è§ˆ</a></li>
      <li class="toc-level-1"><a href="#radar-chart">é£é™©é›·è¾¾å›¾</a></li>
      {% if policy_audit %}
      <li class="toc-level-1"><a href="#policy-audit">å£å¾„ä¸€è‡´æ€§å®¡è®¡</a></li>
      {% endif %}
      <li class="toc-level-1"><a href="#fix-summary">ä¿®å¤å»ºè®®æ‘˜è¦</a></li>
      <li class="toc-level-1"><a href="#statistical-leakage">ç»Ÿè®¡ç±»æ³„æ¼æ£€æµ‹</a></li>
      {% if simulation %}
      <li class="toc-level-1"><a href="#simulation-results">æ—¶åºæ¨¡æ‹Ÿç»“æœ</a></li>
      {% endif %}
      <li class="toc-level-1"><a href="#detailed-risks">è¯¦ç»†æ£€æµ‹ç»“æœ</a></li>
      <li class="toc-level-2"><a href="#target-leakage">ç›®æ ‡æ³„æ¼æ£€æµ‹</a></li>
      <li class="toc-level-2"><a href="#group-leakage">åˆ†ç»„æ³„æ¼æ£€æµ‹</a></li>
      <li class="toc-level-2"><a href="#time-issues">æ—¶é—´åˆ—é—®é¢˜</a></li>
      <li class="toc-level-2"><a href="#cv-consistency">CVç­–ç•¥ä¸€è‡´æ€§</a></li>
    </ul>
  </div>

  <!-- é£é™©çŸ©é˜µ -->
  <div class="risk-matrix" id="risk-matrix">
    <h2>ğŸ“Š é£é™©çŸ©é˜µæ¦‚è§ˆ</h2>
    {% set high_risks = results["risks"] | selectattr("severity", "equalto", "high") | list %}
    {% set medium_risks = results["risks"] | selectattr("severity", "equalto", "medium") | list %}
    {% set low_risks = results["risks"] | selectattr("severity", "equalto", "low") | list %}
    
    <div class="matrix-grid">
      <div class="matrix-card high">
        <p class="count">{{ high_risks|length }}</p>
        <p class="label">é«˜å±é£é™©</p>
      </div>
      <div class="matrix-card medium">
        <p class="count">{{ medium_risks|length }}</p>
        <p class="label">ä¸­å±é£é™©</p>
      </div>
      <div class="matrix-card low">
        <p class="count">{{ low_risks|length }}</p>
        <p class="label">ä½å±é£é™©</p>
      </div>
      <div class="matrix-card" style="border-left-color:#6c757d; background:#e9ecef">
        <p class="count">{{ results["risks"]|length }}</p>
        <p class="label">æ€»é£é™©æ•°</p>
      </div>
    </div>
    
    {% if policy_audit %}
    <div style="margin-top:1rem; padding-top:1rem; border-top:1px solid #dee2e6">
      <h3>å£å¾„ä¸€è‡´æ€§çŠ¶æ€</h3>
      <div class="policy-summary">
        <div class="policy-stat">
          <div class="value">{{ policy_audit.summary.total_violations }}</div>
          <div class="label">ç­–ç•¥è¿è§„</div>
        </div>
        <div class="policy-stat">
          <div class="value">{{ policy_audit.summary.high_severity }}</div>
          <div class="label">é«˜å±è¿è§„</div>
        </div>
        <div class="policy-stat">
          <div class="value">{{ policy_audit.summary.compliance_status }}</div>
          <div class="label">åˆè§„çŠ¶æ€</div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- é£é™©é›·è¾¾å›¾ -->
  <div class="radar-chart" id="radar-chart">
    <h3>ğŸ¯ é£é™©é›·è¾¾å›¾</h3>
    <div class="radar-container">
      <svg class="radar-svg" viewBox="0 0 400 400" id="riskRadarChart">
        <!-- é›·è¾¾å›¾å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
      </svg>
    </div>
  </div>

  <!-- å£å¾„ä¸€è‡´æ€§å®¡è®¡ -->
  {% if policy_audit %}
  <div class="policy-audit" id="policy-audit">
    <h2>ğŸ” å£å¾„ä¸€è‡´æ€§å®¡è®¡</h2>
    <p><em>å¯¹æ¯”å½“å‰æ•°æ®ä¸ç­–ç•¥é…ç½®ï¼Œè¯†åˆ«ç¦»çº¿/åœ¨çº¿å£å¾„å·®å¼‚</em></p>
    
    {% if policy_audit.violations %}
    <h3>ç­–ç•¥è¿è§„è¯¦æƒ…</h3>
    {% for violation in policy_audit.violations %}
    <div class="risk sev-{{ 'high' if violation.severity=='high' else 'medium' if violation.severity=='medium' else 'low' }}">
      <h4>{{ violation.violation_type.replace('_', ' ').title() }} 
        <span class="leak-score">[{{ violation.severity.upper() }}]</span>
      </h4>
      <p><strong>é—®é¢˜ï¼š</strong>{{ violation.message }}</p>
      <p><strong>æœŸæœ›ï¼š</strong>{{ violation.expected }}</p>
      <p><strong>å®é™…ï¼š</strong>{{ violation.actual }}</p>
      <p><strong>å»ºè®®ï¼š</strong>{{ violation.recommendation }}</p>
    </div>
    {% endfor %}
    {% else %}
    <p>âœ… æœªå‘ç°ç­–ç•¥è¿è§„ï¼Œæ•°æ®ä¸é…ç½®å®Œå…¨ä¸€è‡´ã€‚</p>
    {% endif %}
  </div>
  {% endif %}

  <!-- ä¿®å¤å»ºè®®æ‘˜è¦ -->
  <div class="section" id="fix-summary">
    <h2>ğŸ”§ ä¿®å¤å»ºè®®æ‘˜è¦</h2>
    {% if results["risks"] %}
    {% if high_risks %}
    <div class="fix-card fix-high">
      <h4>ğŸš¨ é«˜å±é—®é¢˜ï¼ˆ{{ high_risks|length }}ä¸ªï¼‰</h4>
      <ul>
      {% for r in high_risks %}
        <li><strong>{{ r["name"] }}</strong>
          {% if r["name"].startswith("Target leakage") %}
            - ç«‹å³åˆ é™¤æˆ–åœ¨CVå†…é‡ç®—ç›¸å…³åˆ—
          {% elif r["name"].startswith("Target Encoding") %}
            - æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†å…¨é‡ç›®æ ‡ç¼–ç ï¼Œæ”¹ä¸ºCVå†…ç¼–ç 
          {% elif r["name"].startswith("WOE") %}
            - æ£€æŸ¥WOEè®¡ç®—æ˜¯å¦ä½¿ç”¨äº†æœªæ¥ä¿¡æ¯
          {% elif r["name"].startswith("Rolling statistics") %}
            - ç¡®ä¿æ»šåŠ¨ç»Ÿè®¡ä»…ä½¿ç”¨å†å²çª—å£æ•°æ®
          {% elif r["name"].startswith("Aggregation traces") %}
            - æ£€æŸ¥èšåˆç»Ÿè®¡æ˜¯å¦åœ¨CVå†…æ­£ç¡®è®¡ç®—
          {% endif %}
          {% if r.get("leak_score", 0) > 0 %}
          <span class="leak_score">[é£é™©åˆ†: {{ "%.2f"|format(r["leak_score"]) }}]</span>
          {% endif %}
        </li>
      {% endfor %}
      </ul>
    </div>
    {% endif %}
    
    {% if medium_risks %}
    <div class="fix-card fix-medium">
      <h4>âš ï¸ ä¸­å±é—®é¢˜ï¼ˆ{{ medium_risks|length }}ä¸ªï¼‰</h4>
      <ul>
      {% for r in medium_risks %}
        <li><strong>{{ r["name"] }}</strong>
          {% if r["name"].startswith("KFold leakage") %}
            - è€ƒè™‘ä½¿ç”¨GroupKFoldé¿å…ç»„é—´æ³„æ¼
          {% elif r["name"].startswith("Target leakage (categorical") %}
            - æ£€æŸ¥ç±»åˆ«ç‰¹å¾æ˜¯å¦ç”±ç›®æ ‡èšåˆäº§ç”Ÿ
          {% endif %}
          {% if r.get("leak_score", 0) > 0 %}
          <span class="leak_score">[é£é™©åˆ†: {{ "%.2f"|format(r["leak_score"]) }}]</span>
          {% endif %}
        </li>
      {% endfor %}
      </ul>
    </div>
    {% endif %}
    
    {% if low_risks %}
    <div class="fix-card fix-low">
      <h4>ğŸ’¡ å»ºè®®ä¼˜åŒ–ï¼ˆ{{ low_risks|length }}ä¸ªï¼‰</h4>
      <ul>
      {% for r in low_risks %}
        <li><strong>{{ r["name"] }}</strong>
          {% if r["name"].startswith("Time-awareness") %}
            - ä½¿ç”¨æ—¶é—´æ„ŸçŸ¥çš„ç‰¹å¾å·¥ç¨‹å’ŒéªŒè¯ç­–ç•¥
          {% elif r["name"].startswith("CV strategy recommendation") %}
            - è€ƒè™‘é‡‡ç”¨æ¨èçš„CVç­–ç•¥
          {% endif %}
          {% if r.get("leak_score", 0) > 0 %}
          <span class="leak_score">[é£é™©åˆ†: {{ "%.2f"|format(r["leak_score"]) }}]</span>
          {% endif %}
        </li>
      {% endfor %}
      </ul>
    </div>
    {% endif %}
    
    <p><strong>è¯¦ç»†ä¿®å¤ä»£ç è§ï¼š</strong> <code>fix_transforms.py</code></p>
  </div>
  {% else %}
  <div class="section" id="fix-summary">
    <h2>ğŸ”§ ä¿®å¤å»ºè®®æ‘˜è¦</h2>
    <p>âœ… æœªå‘ç°æ˜æ˜¾é£é™©é¡¹ã€‚</p>
  </div>
  {% endif %}

  <!-- ç»Ÿè®¡ç±»æ³„æ¼æ£€æµ‹ -->
  <div class="stat-leak-section" id="statistical-leakage">
    <h2>ğŸ“Š Statistical Leakage Detection</h2>
    <p><em>v0.3æ–°å¢ï¼šæ£€æµ‹ç›®æ ‡ç¼–ç (TE)ã€WOEã€æ»šåŠ¨ç»Ÿè®¡ç­‰ç»Ÿè®¡ç±»æ³„æ¼</em></p>
    
    {% set stat_risks = [] %}
    {% for r in results["risks"] %}
      {% if "Target Encoding" in r["name"] or "WOE" in r["name"] or "Rolling statistics" in r["name"] or "Aggregation traces" in r["name"] %}
        {% set _ = stat_risks.append(r) %}
      {% endif %}
    {% endfor %}
    
    {% if stat_risks %}
      <h3>æ£€æµ‹åˆ°çš„ç»Ÿè®¡ç±»æ³„æ¼é£é™©</h3>
      {% for r in stat_risks %}
        <div class="risk sev-{{ 'high' if r['severity']=='high' else 'medium' if r['severity']=='medium' else 'low' }}">
          <h4>{{ r["name"] }} 
            {% if r.get("leak_score", 0) > 0 %}
            <span class="leak_score">[é£é™©åˆ†: {{ "%.2f"|format(r["leak_score"]) }}]</span>
            {% endif %}
          </h4>
          <p>{{ r["detail"] }}</p>
          
          {% if r["evidence"].get("suspicious_columns") %}
          <div>
            <span class="evidence-toggle" onclick="toggleEvidence('{{ r['name']|replace(' ', '_') }}')">ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†è¯æ®</span>
            <div id="{{ r['name']|replace(' ', '_') }}" class="evidence-details">
              <h5>å¯ç–‘ç‰¹å¾è¯¦æƒ…ï¼š</h5>
              <table class="comparison-table">
                <tr>
                  <th>ç‰¹å¾å</th>
                  <th>ç›¸å…³æ€§</th>
                  <th>é£é™©åˆ†</th>
                  <th>å»ºè®®</th>
                </tr>
                {% for col, details in r["evidence"]["suspicious_columns"].items() %}
                <tr class="leak-{{ 'high' if details.get('leak_score', 0) >= 0.7 else 'medium' if details.get('leak_score', 0) >= 0.5 else 'low' }}">
                  <td><code>{{ col }}</code></td>
                  <td>{{ "%.3f"|format(details.get('correlation', 0)) }}</td>
                  <td>{{ "%.2f"|format(details.get('leak_score', 0)) }}</td>
                  <td>
                    {% if 'te' in col.lower() or 'target_enc' in col.lower() %}
                      åˆ é™¤æˆ–æ”¹ä¸ºCVå†…ç¼–ç 
                    {% elif 'woe' in col.lower() %}
                      æ£€æŸ¥WOEè®¡ç®—æ—¶é—´çª—å£
                    {% elif 'rolling' in col.lower() or 'moving' in col.lower() %}
                      ç¡®ä¿ä»…ä½¿ç”¨å†å²çª—å£
                    {% else %}
                      æ£€æŸ¥èšåˆç»Ÿè®¡è®¡ç®—æ–¹å¼
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </table>
            </div>
          </div>
          {% else %}
          <pre>{{ r["evidence"] | tojson(indent=2) }}</pre>
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      <p>âœ… æœªæ£€æµ‹åˆ°æ˜æ˜¾çš„ç»Ÿè®¡ç±»æ³„æ¼é£é™©ã€‚</p>
    {% endif %}
  </div>

  <!-- æ—¶åºæ¨¡æ‹Ÿç»“æœ -->
  {% if simulation %}
  <div class="simulation-results" id="simulation-results">
    <h2>â° Time Series Simulation Results</h2>
    <p><em>å¯¹æ¯”TimeSeriesSplitä¸KFoldçš„OOFæŒ‡æ ‡å˜åŒ–</em></p>
    
    {% if simulation.get("error") %}
      <p style="color: #d9534f;">âŒ æ¨¡æ‹Ÿå¤±è´¥ï¼š{{ simulation["error"] }}</p>
    {% else %}
      <div>
        <h3>æ¨¡æ‹Ÿæ‘˜è¦</h3>
        <ul>
          <li>æ€»ç‰¹å¾æ•°ï¼š{{ simulation["summary"]["total_features"] }}</li>
          <li>æ³„æ¼ç‰¹å¾æ•°ï¼š{{ simulation["summary"]["leak_features"] }}</li>
          <li>é«˜å±æ³„æ¼ç‰¹å¾æ•°ï¼š{{ simulation["summary"]["high_leak_features"] }}</li>
          <li>æ³„æ¼ç‡ï¼š{{ "%.1f"|format(simulation["summary"]["leak_rate"] * 100) }}%</li>
          <li>å¹³å‡åˆ†æ•°å·®å¼‚ï¼š{{ "%.4f"|format(simulation["summary"]["avg_score_diff"]) }}</li>
          <li>æœ€å¤§åˆ†æ•°å·®å¼‚ï¼š{{ "%.4f"|format(simulation["summary"]["max_score_diff"]) }}</li>
        </ul>
      </div>
      
      {% if simulation["simulation_results"]["comparisons"] %}
      <div>
        <h3>è¯¦ç»†å¯¹æ¯”ç»“æœ</h3>
        <table class="comparison-table">
          <tr>
            <th>ç‰¹å¾å</th>
            <th>TimeSeries CV</th>
            <th>KFold CV</th>
            <th>åˆ†æ•°å·®å¼‚</th>
            <th>æ³„æ¼çŠ¶æ€</th>
            <th>ä¸¥é‡ç¨‹åº¦</th>
          </tr>
          {% for comp in simulation["simulation_results"]["comparisons"] %}
          <tr class="leak-{{ comp.get('leak_severity', 'none') }}">
            <td><code>{{ comp["feature"] }}</code></td>
            <td>{{ "%.4f"|format(comp["timeseries_cv"]["mean"]) }} Â± {{ "%.4f"|format(comp["timeseries_cv"]["std"]) }}</td>
            <td>{{ "%.4f"|format(comp["kfold_cv"]["mean"]) }} Â± {{ "%.4f"|format(comp["kfold_cv"]["std"]) }}</td>
            <td>{{ "%.4f"|format(comp["score_difference"]) }}</td>
            <td>{% if comp["is_leak"] %}ğŸš¨ æ˜¯{% else %}âœ… å¦{% endif %}</td>
            <td>{{ comp.get("leak_severity", "none").upper() }}</td>
          </tr>
          {% endfor %}
        </table>
      </div>
      {% endif %}
    {% endif %}
  </div>
  {% endif %}

  <!-- è¯¦ç»†æ£€æµ‹ç»“æœ -->
  <div class="section" id="detailed-risks">
    <h2>ğŸ“‹ è¯¦ç»†æ£€æµ‹ç»“æœ</h2>
    {% if results["risks"] %}
      {% for r in results["risks"] %}
        <div class="risk sev-{{ 'high' if r['severity']=='high' else 'medium' if r['severity']=='medium' else 'low' }}">
          <h3>{{ r["name"] }}ï¼ˆ{{ r["severity"] }}ï¼‰
            {% if r.get("leak_score", 0) > 0 %}
            <span class="leak_score">[é£é™©åˆ†: {{ "%.2f"|format(r["leak_score"]) }}]</span>
            {% endif %}
          </h3>
          <p>{{ r["detail"] }}</p>
          <pre>{{ r["evidence"] | tojson(indent=2) }}</pre>
        </div>
      {% endfor %}
    {% else %}
      <p>âœ… æœªå‘ç°æ˜æ˜¾é£é™©é¡¹ã€‚</p>
    {% endif %}
  </div>

  <!-- é¡µè„š -->
  <div class="footer">
    <h3>ğŸ“Š æŠ¥å‘Šå…ƒæ•°æ®</h3>
    <div class="meta">
      <div class="meta-item">
        <div class="label">ç”Ÿæˆæ—¶é—´</div>
        <div class="value">{{ now }}</div>
      </div>
      <div class="meta-item">
        <div class="label">ç‰ˆæœ¬</div>
        <div class="value">Leakage Buster v1.0.0</div>
      </div>
      <div class="meta-item">
        <div class="label">Git Hash</div>
        <div class="value">{{ meta.get("git_hash", "unknown") }}</div>
      </div>
      <div class="meta-item">
        <div class="label">éšæœºç§å­</div>
        <div class="value">{{ meta.get("random_seed", "42") }}</div>
      </div>
      <div class="meta-item">
        <div class="label">å¼•æ“</div>
        <div class="value">{{ meta.get("engine", "pandas") }}</div>
      </div>
      <div class="meta-item">
        <div class="label">å¹¶è¡Œæ•°</div>
        <div class="value">{{ meta.get("n_jobs", "auto") }}</div>
      </div>
    </div>
    <p><em>æŠ¥å‘Šç”Ÿæˆæ—¶é—´ï¼š{{ now }} | Leakage Buster v1.0.0</em></p>
  </div>
</div>

<script>
function toggleEvidence(id) {
  var element = document.getElementById(id);
  if (element.style.display === "none") {
    element.style.display = "block";
  } else {
    element.style.display = "none";
  }
}

// ç”Ÿæˆé£é™©é›·è¾¾å›¾
function generateRadarChart() {
  const svg = document.getElementById('riskRadarChart');
  const width = 400;
  const height = 400;
  const centerX = width / 2;
  const centerY = height / 2;
  const radius = 150;
  
  // æ¸…ç©ºSVG
  svg.innerHTML = '';
  
  // é£é™©ç±»åˆ«æ•°æ®
  const riskData = {
    'ç›®æ ‡æ³„æ¼': {{ high_risks|length + medium_risks|length }},
    'ç»Ÿè®¡æ³„æ¼': {{ stat_risks|length }},
    'æ—¶é—´æ³„æ¼': {{ results["risks"]|selectattr("name", "equalto", "Time parse errors")|list|length + results["risks"]|selectattr("name", "equalto", "Time-awareness suggestion")|list|length }},
    'åˆ†ç»„æ³„æ¼': {{ results["risks"]|selectattr("name", "equalto", "KFold leakage risk (use GroupKFold)")|list|length }},
    'ç­–ç•¥è¿è§„': {{ policy_audit.summary.total_violations if policy_audit else 0 }}
  };
  
  const maxValue = Math.max(...Object.values(riskData));
  const categories = Object.keys(riskData);
  const numCategories = categories.length;
  
  // ç»˜åˆ¶ç½‘æ ¼
  for (let i = 1; i <= 5; i++) {
    const r = (radius * i) / 5;
    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    circle.setAttribute('cx', centerX);
    circle.setAttribute('cy', centerY);
    circle.setAttribute('r', r);
    circle.setAttribute('fill', 'none');
    circle.setAttribute('stroke', '#e0e0e0');
    circle.setAttribute('stroke-width', '1');
    svg.appendChild(circle);
  }
  
  // ç»˜åˆ¶è½´çº¿
  for (let i = 0; i < numCategories; i++) {
    const angle = (2 * Math.PI * i) / numCategories - Math.PI / 2;
    const x = centerX + radius * Math.cos(angle);
    const y = centerY + radius * Math.sin(angle);
    
    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    line.setAttribute('x1', centerX);
    line.setAttribute('y1', centerY);
    line.setAttribute('x2', x);
    line.setAttribute('y2', y);
    line.setAttribute('stroke', '#e0e0e0');
    line.setAttribute('stroke-width', '1');
    svg.appendChild(line);
    
    // æ·»åŠ æ ‡ç­¾
    const labelX = centerX + (radius + 20) * Math.cos(angle);
    const labelY = centerY + (radius + 20) * Math.sin(angle);
    
    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    text.setAttribute('x', labelX);
    text.setAttribute('y', labelY);
    text.setAttribute('text-anchor', 'middle');
    text.setAttribute('dominant-baseline', 'middle');
    text.setAttribute('font-size', '12');
    text.setAttribute('fill', '#666');
    text.textContent = categories[i];
    svg.appendChild(text);
  }
  
  // ç»˜åˆ¶æ•°æ®å¤šè¾¹å½¢
  const points = [];
  for (let i = 0; i < numCategories; i++) {
    const angle = (2 * Math.PI * i) / numCategories - Math.PI / 2;
    const value = riskData[categories[i]];
    const normalizedValue = maxValue > 0 ? value / maxValue : 0;
    const x = centerX + radius * normalizedValue * Math.cos(angle);
    const y = centerY + radius * normalizedValue * Math.sin(angle);
    points.push(`${x},${y}`);
  }
  
  const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
  polygon.setAttribute('points', points.join(' '));
  polygon.setAttribute('fill', 'rgba(102, 126, 234, 0.3)');
  polygon.setAttribute('stroke', '#667eea');
  polygon.setAttribute('stroke-width', '2');
  svg.appendChild(polygon);
  
  // æ·»åŠ æ•°æ®ç‚¹
  for (let i = 0; i < numCategories; i++) {
    const angle = (2 * Math.PI * i) / numCategories - Math.PI / 2;
    const value = riskData[categories[i]];
    const normalizedValue = maxValue > 0 ? value / maxValue : 0;
    const x = centerX + radius * normalizedValue * Math.cos(angle);
    const y = centerY + radius * normalizedValue * Math.sin(angle);
    
    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    circle.setAttribute('cx', x);
    circle.setAttribute('cy', y);
    circle.setAttribute('r', '4');
    circle.setAttribute('fill', '#667eea');
    svg.appendChild(circle);
    
    // æ·»åŠ æ•°å€¼æ ‡ç­¾
    const valueText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    valueText.setAttribute('x', x);
    valueText.setAttribute('y', y - 10);
    valueText.setAttribute('text-anchor', 'middle');
    valueText.setAttribute('font-size', '10');
    valueText.setAttribute('fill', '#333');
    valueText.textContent = value;
    svg.appendChild(valueText);
  }
}

// å¹³æ»‘æ»šåŠ¨åˆ°é”šç‚¹
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
  anchor.addEventListener('click', function (e) {
    e.preventDefault();
    const target = document.querySelector(this.getAttribute('href'));
    if (target) {
      target.scrollIntoView({
        behavior: 'smooth',
        block: 'start'
      });
    }
  });
});

// é¡µé¢åŠ è½½å®Œæˆåç”Ÿæˆé›·è¾¾å›¾
document.addEventListener('DOMContentLoaded', function() {
  generateRadarChart();
});
</script>
</html>

