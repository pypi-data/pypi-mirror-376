# –ü–∞–∫–µ—Ç llm_common

–°–æ–¥–µ—Ä–∂–∏—Ç
- **Prometheus –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –º–µ—Ç—Ä–∏–∫ –¥–ª—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –¥–µ–π—Å—Ç–≤–∏–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- **HTTP –∫–ª–∏–µ–Ω—Ç—ã**: –ì–æ—Ç–æ–≤—ã–µ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é HTTP –∫–ª–∏–µ–Ω—Ç—ã –¥–ª—è LLM –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Ç—Ä–µ–∫–∏–Ω–≥–æ–º
- **–î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä—ã**: –ì–æ—Ç–æ–≤—ã–µ –ø—Ä–∏–º–∏—Ç–∏–≤—ã –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
- **FastAPI –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**: Middleware –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è http –º–µ—Ç—Ä–∏–∫ –∏ endpoint –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –º–µ—Ç—Ä–∏–∫
- **Flask –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**: endpoint –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –º–µ—Ç—Ä–∏–∫

–ó–∞–¥–∞–Ω–∏–µ: –ü–æ–¥–∫–ª—é—á–∏ –≤ –ø—Ä–æ–µ–∫—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫, —É—Å—Ç–∞–Ω–æ–≤–∏–≤ –ø–∞–∫–µ—Ç llm_common.

–î–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å–µ–∫—Ü–∏–π –∫–æ–¥–∞.
–î–ª—è Telegram –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∏ callback –µ—Å–ª–∏ —ç—Ç–æ telegram –±–æ—Ç.
–°–¥–µ–ª–∞–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å FastApi, –µ—Å–ª–∏ –≤ —ç—Ç–æ–º –ø—Ä–æ–µ–∫—Ç–µ –æ–Ω –µ—Å—Ç—å.
–ò—Å–ø–æ–ª—å–∑—É–π HTTPX –æ–±–µ—Ä—Ç–∫—É —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º –¥–ª—è —Å—ã—Ä—ã—Ö http –∑–∞–ø—Ä–æ—Å–æ–≤.

### 0. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç prometheus_client –≤ –ø—Ä–æ–µ–∫—Ç–µ

### 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫

–ú–µ—Ç—Ä–∏–∫–∏ –Ω—É–∂–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å, –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å–º–æ–∂–µ—Ç –ø–æ–¥—Å—Ç–∞–≤–ª—è—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –∑–Ω–∞—á–µ–Ω–∏—è –≤ –ª–µ–π–±–ª—ã –º–µ—Ç—Ä–∏–∫
–ü—Ä–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã, –∫—Ä–æ–º–µ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ä–µ–¥—ã.

```python
from llm_common.prometheus import build_prometheus_metrics

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
metrics = build_prometheus_metrics(
    project_name="projectname",
    env="dev"  # –ê—Ä–≥—É–º–µ–Ω—Ç env –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∑–Ω–∞—á–µ–Ω–∏—è dev, preprod prod !!!
)
```

### 2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ HTTP –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å –≤—Å—Ç—Ä–µ–Ω–Ω—ã–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ–º http –∑–∞–ø—Ä–æ—Å–æ–≤

–ï—Å–ª–∏ –≤ –ø—Ä–æ–µ–∫—Ç–µ –µ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å HTTPX, —Ç–æ –¥–ª—è –Ω–µ–≥–æ –µ—Å—Ç—å –æ–±–µ—Ä—Ç–∫–∞ —Å –≤—Å—Ç—Ä–µ–Ω–Ω—ã–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ–º http –∑–∞–ø—Ä–æ—Å–æ–≤

```python
from llm_common.clients.llm_http_client import LLMHttpClient
from langchain_openai import ChatOpenAI

# LLM –∫–ª–∏–µ–Ω—Ç —Å OpenAI –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º
custom_aclient = LLMHttpClient(verify=False)

chat_model = ChatOpenAI(
    ...,
    http_async_client=custom_aclient,
)
```

–ï—Å–ª–∏ –≤ –ø—Ä–æ–µ–∫—Ç–µ –µ—Å—Ç—å http –∑–∞–ø—Ä–æ—Å—ã, —Ç–æ –¥–ª—è –Ω–∏—Ö –∏—Å–ø–æ–ª—å–∑—É–π AuthHttpClient –≤ –∫–æ—Ç–æ—Ä–æ–π –µ—Å—Ç—å –æ–±–µ—Ä—Ç–∫–∞ —Å –≤—Å—Ç—Ä–µ–Ω–Ω—ã–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ–º http –∑–∞–ø—Ä–æ—Å–æ–≤

```python
from llm_common.clients.auth_client import AuthHttpClient

async with AuthHttpClient() as client:
    response = await client.post("https://auth-service.com/api/check")
```

### 3. –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∏ —Å—Ç–∞—Ç—É—Å–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–µ–∫—Ü–∏–π –∫–æ–¥–∞ —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –∏–ª–∏ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä

–ß—Ç–æ–±—ã —ç—Ç–∏ –ø—Ä–∏–º–∏—Ç–∏–≤—ã —Å–º–æ–≥–ª–∏ –æ—Ç—Å–ª–µ–¥–∏—Ç—å –≤–æ–∑–Ω–∏–∫–ª–æ–≤–∞–Ω–∏—è exception, –≤–Ω—É—Ç—Ä–∏ —ç—Ç–∏—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞ –Ω–µ –¥–æ–ª–∂–Ω—ã
–ø–æ–¥–∞–≤–ª—è—Ç—å—Å—è exception.

```python
from llm_common.prometheus import action_tracking, action_tracking_decorator

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä–∞
with action_tracking("data_processing") as tracker:
    # –í–∞—à –∫–æ–¥
    processed_data = process_data()
    # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —Ç—Ä–µ–∫–∏–Ω–≥ —Ä–∞–∑–º–µ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
    tracker.size(len(processed_data))

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞
@action_tracking_decorator("llm_request")
async def make_llm_request():
    # –í–∞—à –∫–æ–¥
    return result
```

### 4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å FastAPI

```python
from fastapi import FastAPI
from llm_common.prometheus import fastapi_tracking_middleware, fastapi_endpoint_for_prometheus

app = FastAPI()

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ middleware –¥–ª—è —Ç—Ä–µ–∫–∏–Ω–≥–∞ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
app.middleware("http")(fastapi_tracking_middleware)

# Endpoint –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –º–µ—Ç—Ä–∏–∫ Prometheus
app.get("/prometheus")(fastapi_endpoint_for_prometheus)
```

### 4.1. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Flask

```python
from flask import Flask
from llm_common.prometheus import flask_endpoint_for_prometheus

flask_app = Flask()

# Endpoint –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –º–µ—Ç—Ä–∏–∫ Prometheus
flask_app.get("/prometheus")(flask_endpoint_for_prometheus)
```

### 5. –ë–æ—Ç—ã Telegram

–•–æ—Ä–æ—à–µ–π –ø—Ä–∞–∫—Ç–∏–∫–æ–π —è–≤–ª—è–µ—Ç—Å—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—Å–µ—Ö —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤.

–ü—Ä–∏–º–µ–Ω—è–π–µ—Ç—Å—è –Ω–∞ —Ö–µ–Ω–¥–ª–µ—Ä—ã –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ callback –∫–Ω–æ–ø–æ–∫ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä –∏–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä—ã action_tracking –∏ action_tracking_decorator
–í –∫–∞—á–µ—Å—Ç–≤–µ –∏–º–µ–Ω–∏ —É–∫–∞–∑—ã–≤–∞–π—Ç–µ —Å—É—Ñ—Ñ–∏–∫—Å "_handler" action_tracking(name="menu_handler"), —ç—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –æ—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –Ω–∞ 
–≥—Ä–∞—Ñ–∏–∫–µ —Ç–æ–ª—å–∫–æ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è —Ö—ç–Ω–¥–ª–µ—Ä–æ–≤

### 5.1 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è c python-telegram-bot

–ß—Ç–æ–±—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å HTTP –∑–∞–ø—Ä–æ—Å—ã –∫ API Telegram:

```python
from llm_common.prometheus import HTTPXTransportWithMonitoring
from telegram.request import HTTPXRequest
from telegram.ext import ApplicationBuilder

transport = HTTPXTransportWithMonitoring()
httpx_request = HTTPXRequest(
    httpx_kwargs={"transport": transport}
)

application_builder = (
    ApplicationBuilder()
    .request(httpx_request)
)
```

### 6. –ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö action

–î–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ Telegram, —Å—É—Ñ—Ñ–∏–∫—Å "_handler"
–î–ª—è —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –∑–∞–¥–∞—á, —Å—É—Ñ—Ñ–∏–∫—Å "_task"
–î–ª—è –≤—ã–∑–æ–≤–æ–≤ llm, —Å—É—Ñ—Ñ–∏–∫—Å "_llm_call"
–î–ª—è –∑–∞–ø—É—Å–∫–∞ –∞–≥–µ–Ω—Ç–∞ llm, —Å—É—Ñ—Ñ–∏–∫—Å "_agent"

## üìñ API –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

#### action_tracking(name: str)
–ö–æ–Ω—Ç–µ–∫—Å—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–º–µ—Ä—è–µ—Ç –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ—Ç —É—Å–ø–µ—à–Ω—ã–µ –∏ –æ—à–∏–±–æ—á–Ω—ã–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –ü–æ–∑–≤–æ–ª—è–µ—Ç —Ç—Ä–µ–∫–∏—Ç—å —Ä–∞–∑–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

#### action_tracking_decorator(name: str)
–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π –∏ –∫–æ—Ä—É—Ç–∏–Ω, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ `action_tracking`.

## üîç –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏

–í—Å–µ –º–µ—Ç—Ä–∏–∫–∏ –∏–º–µ—é—Ç –ø—Ä–µ—Ñ–∏–∫—Å `genapp_`:

#### HTTP –º–µ—Ç—Ä–∏–∫–∏:
- `genapp_http_requests_total` - –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
- `genapp_http_request_duration_sec` - –ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- `genapp_http_request_size_bytes` - –†–∞–∑–º–µ—Ä –∑–∞–ø—Ä–æ—Å–æ–≤/–æ—Ç–≤–µ—Ç–æ–≤

#### –ú–µ—Ç—Ä–∏–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π:
- `genapp_action_count_total` - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
- `genapp_action_duration_sec` - –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π
- `genapp_action_size_total` - –†–∞–∑–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### Labels (—Ç–µ–≥–∏)

–ú–µ—Ç—Ä–∏–∫–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç labels:
- http_requests_total ‚Üí method, status, resource, app_type, env, app
- http_request_duration_sec ‚Üí method, status, resource, app_type, env, app
- http_request_size_bytes ‚Üí resource, status, method, direction, app_type, env, app
- action_count_total ‚Üí name, status, env, app
- action_duration_sec ‚Üí name, env, app
- action_size_total ‚Üí name, env, app
