import shutil
import subprocess
import json
from pathlib import Path

def scan_file(file_path: Path):
    issues = []

    # Check if semgrep is installed
    if not shutil.which("semgrep"):
        return [{
            "file": str(file_path),
            "type": "Semgrep Not Installed",
            "message": "Semgrep is not installed. Run `uv pip install semgrep`.",
            "line": 0,
            "severity": "Low",
        }]

    try:
        print(f"[+] Running Semgrep on {file_path}")
        result = subprocess.run(
            ["semgrep", "--json", str(file_path)],
            capture_output=True,
            text=True,
            check=False,
        )

        if result.returncode not in (0, 1):  # 1 = findings, 0 = no findings
            return [{
                "file": str(file_path),
                "type": "Semgrep Error",
                "message": result.stderr.strip() or "Unknown error running Semgrep.",
                "line": 0,
                "severity": "Low",
            }]

        data = json.loads(result.stdout)
        for finding in data.get("results", []):
            issues.append({
                "file": finding["path"],
                "type": finding["check_id"],
                "message": finding["extra"].get("message", "Semgrep finding"),
                "line": finding["start"]["line"],
                "severity": "Medium",
            })

    except Exception as e:
        issues.append({
            "file": str(file_path),
            "type": "Semgrep Exception",
            "message": str(e),
            "line": 0,
            "severity": "Low",
        })

    return issues
