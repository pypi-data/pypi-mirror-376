(function(S,e){typeof exports=="object"&&typeof module<"u"?e(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],e):(S=typeof globalThis<"u"?globalThis:S||self,e(S.trame_annotations={},S.Vue))})(this,function(S,e){"use strict";function P(g){return e.getCurrentScope()?(e.onScopeDispose(g),!0):!1}function G(){const g=e.ref(1);if(window){let t=function(){g.value=window.devicePixelRatio,n(),o=window.matchMedia(`(resolution: ${g.value}dppx)`),o.addEventListener("change",t,{once:!0})},n=function(){o==null||o.removeEventListener("change",t)},o;t(),P(n)}return{pixelRatio:g}}function U(g){const t=e.ref({width:1,height:1,top:0,left:0});let n=null,o;const l=()=>{n&&(n.disconnect(),n=null),o=void 0},h=()=>{n=new ResizeObserver(y=>{const r=y[y.length-1],{width:p,height:u,top:d,left:b}=r.target.getBoundingClientRect();t.value={width:p,height:u,top:d,left:b}})};return e.watchEffect(()=>{if(o&&(!g.value||g.value!==o)&&l(),!g.value)return;n||h(),o=g.value,n==null||n.observe(o);const{width:y,height:r,top:p,left:u}=o.getBoundingClientRect();t.value={width:y,height:r,top:p,left:u}}),P(l),t}function X(g,t,n,o,l=8,h=16){const y=U(g);return e.computed(()=>{var R;const p=t.value;let u=p.x+l,d=p.y+l;if(!y.value||!n.value)return{left:u,top:d};const b=y.value,f=((R=o.value)==null?void 0:R.getBoundingClientRect())??{left:0,top:0,width:window.innerWidth,height:window.innerHeight},w={left:u-f.left,top:d-f.top,width:b.width+h,height:b.height+h};w.left+w.width>f.width&&(u=p.x-b.width-l),u<f.left&&(u=f.left),w.top+w.height>f.height&&(d=p.y-b.height-l),d<f.top&&(d=f.top);const k=n.value.getBoundingClientRect();return u-=k.left,d-=k.top,{left:u,top:d}})}const Z=g=>{const t=e.ref(!1);return e.onMounted(()=>{t.value=!0}),e.computed(()=>{const o=e.unref(g);return!t.value||!o?null:document.querySelector(o)})},J=[255,0,0],D=[[0,255,0],[0,0,255],[255,165,0],[0,255,255],[255,255,0],[255,0,255],[255,69,0],[255,20,147],[255,215,0]],W=[[255,215,0],[255,20,147],[0,255,255],[255,0,0],[0,255,0]];class M{constructor(t,n=0){this.bounds={x:t.x||0,y:t.y||0,width:t.width,height:t.height},this.maxObjects=typeof t.maxObjects=="number"?t.maxObjects:10,this.maxLevels=typeof t.maxLevels=="number"?t.maxLevels:4,this.level=n,this.objects=[],this.nodes=[]}getIndex(t){return t.qtIndex(this.bounds)}split(){const t=this.level+1,n=this.bounds.width/2,o=this.bounds.height/2,l=this.bounds.x,h=this.bounds.y,y=[{x:l+n,y:h},{x:l,y:h},{x:l,y:h+o},{x:l+n,y:h+o}];for(let r=0;r<4;r++)this.nodes[r]=new M({x:y[r].x,y:y[r].y,width:n,height:o,maxObjects:this.maxObjects,maxLevels:this.maxLevels},t)}insert(t){if(this.nodes.length){const n=this.getIndex(t);for(let o=0;o<n.length;o++)this.nodes[n[o]].insert(t);return}if(this.objects.push(t),this.objects.length>this.maxObjects&&this.level<this.maxLevels){this.nodes.length||this.split();for(let n=0;n<this.objects.length;n++){const o=this.getIndex(this.objects[n]);for(let l=0;l<o.length;l++)this.nodes[o[l]].insert(this.objects[n])}this.objects=[]}}retrieve(t){const n=this.getIndex(t);let o=this.objects;if(this.nodes.length)for(let l=0;l<n.length;l++)o=o.concat(this.nodes[n[l]].retrieve(t));return this.level===0?Array.from(new Set(o)):o}remove(t,n=!1){const o=this.objects.indexOf(t);o>-1&&this.objects.splice(o,1);for(let l=0;l<this.nodes.length;l++)this.nodes[l].remove(t);return this.level===0&&!n&&this.join(),o!==-1}update(t,n=!1){this.remove(t,n),this.insert(t)}join(){let t=Array.from(this.objects);for(let o=0;o<this.nodes.length;o++){const l=this.nodes[o].join();t=t.concat(l)}const n=Array.from(new Set(t));if(n.length<=this.maxObjects){this.objects=n;for(let o=0;o<this.nodes.length;o++)this.nodes[o].objects=[];this.nodes=[]}return t}clear(){this.objects=[];for(let t=0;t<this.nodes.length;t++)this.nodes.length&&this.nodes[t].clear();this.nodes=[]}}class q{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.data=t.data}qtIndex(t){const n=[],o=t.x+t.width/2,l=t.y+t.height/2,h=this.y<l,y=this.x<o,r=this.x+this.width>o,p=this.y+this.height>l;return h&&r&&n.push(0),y&&h&&n.push(1),y&&p&&n.push(2),r&&p&&n.push(3),n}}const K={style:{"font-weight":"500","font-style":"italic"}},Q={style:{"list-style-type":"none","padding-left":"1rem"}},ee={key:1,style:{"list-style-type":"none",padding:"0"}},F=e.defineComponent({__name:"AnnotationPopup",props:{popupAnnotations:{},popupPosition:{},groupByModel:{type:Boolean},relativeParent:{},container:{}},setup(g){const t=g,{popupAnnotations:n,popupPosition:o,relativeParent:l,container:h,groupByModel:y}=e.toRefs(t),r=e.computed(()=>{if(y.value)return n.value.reduce((d,b)=>{const{model_id:f}=b;if(f==null)return d;let w=d[f];return w==null&&(w={name:b.modelName||"",annotations:[]},d[f]=w),w.annotations.push(b),d},{})}),p=e.ref(),u=X(p,o,l,h);return(d,b)=>(e.openBlock(),e.createElementBlock("div",{ref_key:"labelContainer",ref:p,style:e.normalizeStyle({position:"absolute",visibility:e.unref(n).length?"visible":"hidden",left:`${e.unref(u).left}px`,top:`${e.unref(u).top}px`,zIndex:10,padding:"0.4rem",whiteSpace:"pre",fontSize:"small",borderRadius:"0.2rem",borderColor:"rgba(127, 127, 127, 0.75)",borderStyle:"solid",borderWidth:"thin",backgroundColor:"white",listStyleType:"none",pointerEvents:"none",margin:0})},[r.value?(e.openBlock(!0),e.createElementBlock(e.Fragment,{key:0},e.renderList(r.value,(f,w)=>(e.openBlock(),e.createElementBlock("ul",{key:w,style:{"list-style-type":"none",padding:"0"}},[e.createElementVNode("li",null,[e.createElementVNode("span",K,e.toDisplayString(f.name),1),e.createElementVNode("ul",Q,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(f.annotations,k=>(e.openBlock(),e.createElementBlock("li",{key:k.id,style:{display:"flex",alignItems:"center"}},[e.createElementVNode("span",{style:e.normalizeStyle({backgroundColor:`rgb(${k.color.join(",")})`,width:"10px",height:"10px",borderRadius:"50%",display:"inline-block",marginRight:"0.4rem"})},null,4),e.createElementVNode("span",null,e.toDisplayString(k.name),1)]))),128))])])]))),128)):(e.openBlock(),e.createElementBlock("ul",ee,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(n),f=>(e.openBlock(),e.createElementBlock("li",{key:f.id,style:{display:"flex",alignItems:"center"}},[e.createElementVNode("span",{style:e.normalizeStyle({backgroundColor:`rgb(${f.color.join(",")})`,width:"10px",height:"10px",borderRadius:"50%",display:"inline-block",marginRight:"0.4rem"})},null,4),e.createElementVNode("span",null,e.toDisplayString(f.name),1)]))),128))]))],4))}}),te=e.defineComponent({__name:"BoxAnnotations",props:{boxAnnotations:{},imageSize:{},lineWidth:{},lineOpacity:{},popupContainer:{},groupByModel:{type:Boolean}},setup(g){const t=g,{boxAnnotations:n,lineWidth:o,lineOpacity:l}=e.toRefs(t),h=e.ref(),y=e.computed(()=>{var s;return(s=h.value)==null?void 0:s.getContext("2d",{alpha:!0})}),r=e.ref(),p=e.computed(()=>{var s;return(s=r.value)==null?void 0:s.getContext("2d",{willReadFrequently:!0})}),u=e.ref({width:1,height:1,top:0,left:0});let d=null;const b=e.computed(()=>{if(!u.value)return 1;const s=u.value.width/t.imageSize.width,a=u.value.height/t.imageSize.height;return s>a?a:s}),f=e.computed(()=>({width:Math.floor(t.imageSize.width*b.value),height:Math.floor(t.imageSize.height*b.value)})),w=G(),k=e.computed(()=>o.value*w.pixelRatio.value);e.watch([h,y,f,k,l,b,()=>t.boxAnnotations],()=>{!h.value||!y.value||setTimeout(R,0)});function R(){if(!h.value||!y.value)return;const s=h.value,a=y.value,i=f.value;s.width=i.width,s.height=i.height,a.clearRect(0,0,s.width,s.height),a.globalCompositeOperation="lighter",a.lineWidth=k.value;const c=l.value;t.boxAnnotations.forEach(({color:x,bbox:m})=>{a.strokeStyle=`rgba(${[...x,c].join(",")})`,a.strokeRect(m[0]*b.value,m[1]*b.value,m[2]*b.value,m[3]*b.value)})}let O;e.watchEffect(()=>{if(!r.value||!p.value||!u.value)return;const s=r.value,a=p.value;s.width=f.value.width,s.height=f.value.height,a.clearRect(0,0,s.width,s.height),O=new M({width:s.width,height:s.height,maxLevels:8,maxObjects:10}),t.boxAnnotations.forEach((i,c)=>{const[x,m,v,C]=i.bbox.map(E=>E*b.value),j=new q({x,y:m,width:v,height:C,data:c});O.insert(j),a.fillStyle="rgb(255, 0, 0)",a.fillRect(x,m,v,C)})});function L(s,a,i){const{left:c,width:x,top:m,height:v}=i.getBoundingClientRect(),C=x/v/(i.width/i.height),j=1/C;let E;return C>1?E=[(s-c)/x*C-.5*C+.5,(a-m)/v]:E=[(s-c)/x,(a-m)/v*j-.5*j+.5],[i.width*E[0],i.height*E[1]]}const _=e.ref(),I=e.computed(()=>_.value?{x:_.value.clientX,y:_.value.clientY}:{x:0,y:0});function z(s,a){return a.x>=s.x+s.width||s.x>=a.x+a.width?!1:!(a.y>=s.y+s.height||s.y>=a.y+a.height)}const N=e.computed(()=>{if(!r.value||r.value.width===0||!O||!n.value||!p.value)return[];const{x:s,y:a}=I.value,[i,c]=L(s,a,r.value),x=new q({x:i,y:c,width:2,height:2});return O.retrieve(x).filter(m=>z(m,x)).map(m=>m.data).filter(m=>m!=null).map(m=>n.value[m])}),B=e.ref(!1),T=e.computed(()=>B.value?N.value:[]);e.onMounted(()=>{function s(a){const i=a[a.length-1],{width:c,height:x,top:m,left:v}=i.target.getBoundingClientRect();u.value={width:c,height:x,top:m,left:v}}d=new ResizeObserver(s),h.value&&d.observe(h.value)}),e.onBeforeUnmount(()=>{d&&d.disconnect()});function V(s){B.value=!0,_.value=s}return(s,a)=>(e.openBlock(),e.createElementBlock(e.Fragment,null,[e.createElementVNode("canvas",{ref_key:"visibleCanvas",ref:h,style:{width:"100%",position:"absolute",left:"0",top:"0",height:"100%","object-fit":"contain"}},null,512),e.createElementVNode("canvas",{ref_key:"pickingCanvas",ref:r,style:{opacity:"0",width:"100%",position:"absolute",left:"0",top:"0",height:"100%","object-fit":"contain"},onMouseleave:a[0]||(a[0]=i=>B.value=!1),onMousemove:V},null,544),e.createVNode(F,{"popup-annotations":T.value,"popup-position":I.value,"relative-parent":r.value,container:s.popupContainer,"group-by-model":s.groupByModel},null,8,["popup-annotations","popup-position","relative-parent","container","group-by-model"])],64))}}),$=6,A=14,ne=e.defineComponent({__name:"ClassificationAnnotations",props:{classifications:{},popupContainer:{},groupByModel:{type:Boolean}},setup(g){const t=g,n=e.ref(!1),o=e.ref(),l=e.computed(()=>{if(!o.value||!n.value)return{x:0,y:0};const{left:r,top:p,width:u,height:d}=o.value.getBoundingClientRect();return{x:r+u/2,y:p+d-4}}),h=e.computed(()=>t.classifications.length?t.classifications.map(r=>{const{color:p}=r;return`rgb(${p.join(",")})`}).reverse():[]),y=e.computed(()=>n.value?t.classifications:[]);return(r,p)=>(e.openBlock(),e.createElementBlock("div",{ref_key:"classesDot",ref:o,style:e.normalizeStyle([{position:"relative",margin:"0"},{height:`${h.value.length*$+A}px`,width:`${A}px`}]),onMouseenter:p[0]||(p[0]=u=>n.value=!0),onMouseleave:p[1]||(p[1]=u=>n.value=!1)},[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(h.value,(u,d)=>(e.openBlock(),e.createElementBlock("span",{key:d,style:e.normalizeStyle({top:`${h.value.length*$-d*$}px`,position:"absolute",backgroundColor:u,width:`${A}px`,height:`${A}px`,borderRadius:"50%",boxShadow:"0 1px 1px rgba(0, 0, 0, 0.5)"})},null,4))),128)),e.createVNode(F,{"popup-annotations":y.value,"popup-position":l.value,"relative-parent":o.value,container:r.popupContainer,"group-by-model":r.groupByModel},null,8,["popup-annotations","popup-position","relative-parent","container","group-by-model"])],36))}}),oe=["src"],ie=.9,se=2,le={ImageDetection:e.defineComponent({__name:"ImageDetection",props:{identifier:{},src:{},annotations:{},categories:{},models:{},containerSelector:{},lineWidth:{},lineOpacity:{},selected:{},scoreThreshold:{},colorBy:{}},emits:["hover"],setup(g,{emit:t}){const n=g,o=e.computed(()=>{const i=e.unref(n.annotations);return i?Array.isArray(i)?i:Object.entries(i).map(([x,m])=>[x,e.unref(m)]).filter(([x,m])=>m!=null).map(([x,m])=>m.map(v=>({...v,model_id:parseInt(x)}))).flat():[]}),l=e.computed(()=>e.unref(n.categories)??{}),h=e.computed(()=>e.unref(n.models)??{}),y=e.computed(()=>e.unref(n.containerSelector)??""),r=e.computed(()=>e.unref(n.lineOpacity)??ie),p=e.computed(()=>e.unref(n.lineWidth)??se),u=e.computed(()=>e.unref(n.scoreThreshold)??0),d=e.computed(()=>e.unref(n.colorBy)??"category"),b=e.ref({width:0,height:0}),f=e.ref(),w=e.ref(!0),k=()=>{var i,c;b.value={width:((i=f.value)==null?void 0:i.naturalWidth)??0,height:((c=f.value)==null?void 0:c.naturalHeight)??0}},R=e.computed(()=>o.value.filter(({score:i})=>i==null||i>=u.value).map(i=>{var Y,H;const{category_id:c,model_id:x,label:m,score:v}=i;let C=J;d.value==="category"&&c!=null?C=D[c%D.length]:d.value==="model"&&x!=null&&(C=W[x%W.length]);const j=((Y=l.value[c])==null?void 0:Y.name)??m??"Unknown",E=v!=null?` ${Math.round(v*100)}%`:"",ae=`${j}${E}`,ce=((H=h.value[x])==null?void 0:H.name)??`Unknown model (${x})`;return{...i,color:C,name:ae,modelName:ce}})),O=e.computed(()=>R.value.reduce((i,c)=>("bbox"in c?i.boxAnnotations.push(c):i.classifications.push(c),i),{boxAnnotations:[],classifications:[]})),L=e.computed(()=>O.value.boxAnnotations),_=e.computed(()=>O.value.classifications),I=t;function z(){const i=e.unref(n.identifier);i!=null&&I("hover",{id:i})}function N(){I("hover",{id:""})}const B=Z(y),T=e.computed(()=>n.selected?"4":"0"),V=e.computed(()=>e.unref(n.src)??void 0);function s(i){var c;w.value=!1,(c=i.target)==null||c.addEventListener("transitionend",a)}function a(i){var c;w.value=!0,(c=i.target)==null||c.removeEventListener("transitionend",a)}return e.onMounted(()=>{var i;(i=B.value)==null||i.addEventListener("transitionstart",s)}),e.onBeforeUnmount(()=>{var i,c;(i=B.value)==null||i.removeEventListener("transitionstart",s),(c=B.value)==null||c.removeEventListener("transitionend",a)}),(i,c)=>(e.openBlock(),e.createElementBlock("div",{style:{position:"relative",width:"100%",height:"100%"},onMouseenter:z,onMouseleave:N},[e.createElementVNode("img",{ref_key:"img",ref:f,src:V.value,style:e.normalizeStyle([{outlineWidth:T.value+"px"},{width:"100%",height:"100%","object-fit":"contain","outline-style":"dotted","outline-color":"red"}]),onLoad:k},null,44,oe),w.value&&L.value.length>0?(e.openBlock(),e.createBlock(te,{key:0,"box-annotations":L.value,"image-size":b.value,"line-width":p.value,"line-opacity":r.value,"popup-container":e.unref(B),"group-by-model":d.value==="model"},null,8,["box-annotations","image-size","line-width","line-opacity","popup-container","group-by-model"])):e.createCommentVNode("",!0),w.value&&_.value.length>0?(e.openBlock(),e.createBlock(ne,{key:1,style:{position:"absolute",top:"0.4rem",left:"0.4rem",margin:"0"},classifications:_.value,"popup-container":e.unref(B),"group-by-model":d.value==="model"},null,8,["classifications","popup-container","group-by-model"])):e.createCommentVNode("",!0)],32))}})};function re(g){Object.entries(le).forEach(([t,n])=>{g.component(t,n)})}S.install=re,Object.defineProperty(S,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=trame_annotations.umd.cjs.map
