name: Integration Tests

on:
  push:
    branches: [ devel ]
  pull_request:
    branches: [ devel ]
# Cancel in-progress runs if a newer run is started on a given PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ !contains(github.ref, 'devel') && !contains(github.ref, 'release/')}}

jobs:
  fprime-integration:

    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12", "3.13"]
        fprime-version: ["v3.4.3", "v3.5.1", "v3.6.0", "devel"]
        exclude:
        - python-version: 3.13
          fprime-version: v3.4.3
        - python-version: 3.13
          fprime-version: v3.5.1          
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install System dependencies
        run: |
          python -m pip install --upgrade pip urllib3 setuptools_scm
          sudo apt-get install ninja-build
      - name: Clone fprime and install requirements.txt
        run: |
          git clone --recurse-submodules -b ${{ matrix.fprime-version }} https://github.com/nasa/fprime.git
          pip install -r fprime/requirements.txt || true # Attempt to install fprime package when available
      - name: Install Current fprime-tools
        run: pip install -U .
      # 0x72ad3277 is Fw/Types/Assert.cpp, a file that should be consistent across releases
      - name: Test generation and building on Ref
        working-directory: fprime/Ref
        run: |
          fprime-util generate --make
          fprime-util build
          fprime-util hash-to-file 0x72ad3277
      - name: Test generation and building on Ref with Ninja
        working-directory: fprime/Ref
        run: |
          fprime-util generate --build-cache ./build-ninja
          fprime-util build --build-cache ./build-ninja
          fprime-util hash-to-file 0x72ad3277 --build-cache ./build-ninja
      # 0xf610caa8 is Svc/BufferManager/test/ut/BufferManagerTestMain.cpp, a file that should be consistent
      - name: Test special generation on Ref UTs
        working-directory: fprime/Ref
        run: |
          fprime-util generate --make --build-cache ./special-cache --ut -DFPRIME_ENABLE_AUTOCODER_UTS=OFF
          fprime-util build --build-cache ./special-cache
          fprime-util hash-to-file 0xf610caa8 --build-cache ./special-cache


  visualizer-integration:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout fprime-tools
        uses: actions/checkout@v4
      - name: Checkout fprime core (devel)
        uses: actions/checkout@v4
        with:
          repository: nasa/fprime
          ref: devel
          path: fprime
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.12
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r fprime/requirements.txt
          pip install -U -e .
      - name: Check fprime-util visualize
        run: |
          cd fprime/Ref/Top
          fprime-util generate

          timeout 20s fprime-util visualize  > visualizer.log 2>&1 || true

          grep -q "Generated layout TXT file" visualizer.log
          grep -q "Running on http://" visualizer.log
